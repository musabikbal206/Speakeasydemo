<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpeakEasy - Debug Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #000000;
            color: #facc15;
            overscroll-behavior: none;
        }

        .glass {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(250, 204, 21, 0.3);
            box-shadow: 0 8px 32px 0 rgba(250, 204, 21, 0.1);
        }

        .glass-panel {
            background: rgba(40, 40, 40, 0.6);
            border: 1px solid rgba(250, 204, 21, 0.2);
        }

        .card-completed {
            border: 1px solid rgba(34, 197, 94, 0.5) !important;
            background: rgba(34, 197, 94, 0.1) !important;
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #facc15;
            animation: fall linear forwards;
            z-index: 9999;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        .nav-item.active {
            color: #facc15;
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(250, 204, 21, 0.3);
        }
        .nav-item.active i { transform: scale(1.1); }
        select option { background-color: #000000; color: #facc15; }
    </style>
</head>
<body class="h-[100dvh] w-full md:flex md:items-center md:justify-center md:p-8 overflow-hidden text-yellow-400">

    <div class="glass w-full h-full md:h-[85vh] md:max-w-5xl md:rounded-3xl overflow-hidden flex flex-col md:flex-row relative">
        
        <aside class="hidden md:flex w-64 bg-black/20 flex-col border-r border-yellow-500/20">
            <div class="p-6">
                <h1 class="text-3xl font-extrabold text-yellow-400 tracking-tight"><i class="fas fa-comment-dots mr-2"></i>SpeakEasy</h1>
                <p class="text-yellow-200 text-sm mt-1">Master Your Accent</p>
            </div>
            <nav class="flex-1 overflow-y-auto px-4 space-y-2">
                <button onclick="switchTab('challenge')" id="btn-challenge-desktop" class="w-full text-left px-4 py-3 rounded-xl text-yellow-400 font-semibold transition-all bg-yellow-500/20 hover:bg-yellow-500/30 shadow-sm border border-yellow-500/30">
                    <i class="fas fa-trophy w-6"></i> Challenge Mode
                </button>
                <button onclick="switchTab('freeplay')" id="btn-freeplay-desktop" class="w-full text-left px-4 py-3 rounded-xl text-yellow-200/80 hover:text-yellow-400 hover:bg-white/10 transition-all">
                    <i class="fas fa-keyboard w-6"></i> Free Play (TTS)
                </button>
                <div class="mt-6 px-4">
                    <div class="text-xs uppercase font-bold text-yellow-600 mb-2">Your Stats</div>
                    <div class="text-2xl font-bold text-white" id="stats-count">0 / 120</div>
                </div>
            </nav>
        </aside>

        <main class="flex-1 relative overflow-hidden flex flex-col h-full">
            
            <header class="md:hidden p-4 flex justify-between items-center bg-black/40 backdrop-blur-sm border-b border-yellow-500/20 z-20">
                <div class="flex items-center">
                    <i class="fas fa-comment-dots text-yellow-400 text-xl mr-2"></i>
                    <h1 class="text-lg font-extrabold text-yellow-400 tracking-tight">SpeakEasy</h1>
                </div>
                <div class="bg-yellow-500/20 px-3 py-1 rounded-full border border-yellow-500/30 flex items-center">
                    <i class="fas fa-star text-yellow-400 text-xs mr-2"></i>
                    <span id="mobile-stats-count" class="text-xs font-bold text-white">0/120</span>
                </div>
            </header>

            <div id="browser-warning" class="hidden bg-red-500 text-white px-4 py-2 text-center text-sm font-bold z-30">
                Use Google Chrome on Android or Desktop.
            </div>

            <div id="view-challenge" class="flex-1 flex flex-col p-4 md:p-10 overflow-y-auto pb-24 md:pb-10">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl md:text-2xl font-bold text-yellow-400">Practice Challenges</h2>
                    <select id="category-select" class="w-full md:w-auto bg-black text-yellow-400 border border-yellow-500/50 rounded-xl px-4 py-3 font-bold shadow-lg focus:outline-none focus:ring-2 focus:ring-yellow-300 cursor-pointer"></select>
                </div>

                <div id="cards-container" class="grid grid-cols-1 gap-3 mb-8"></div>

                <div id="practice-area" class="hidden flex-1 flex flex-col items-center pt-4">
                    <button onclick="backToGrid()" class="self-start flex items-center text-yellow-400 mb-6 bg-yellow-500/10 border border-yellow-500/30 px-4 py-2 rounded-full hover:bg-yellow-500/20 backdrop-blur-md">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    
                    <div class="glass-panel w-full max-w-2xl p-6 md:p-8 rounded-3xl shadow-xl text-center relative flex flex-col items-center">
                        <span class="md:absolute md:top-4 md:right-4 text-black bg-yellow-400 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wide mb-4 md:mb-0" id="practice-tag">Tag</span>
                        <h3 class="text-yellow-600 text-xs uppercase tracking-wider font-bold mb-4 md:mt-2">Target Phrase</h3>
                        <p id="target-text" class="text-2xl md:text-4xl font-extrabold text-yellow-300 mb-6 leading-tight px-2">...</p>

                        <div class="flex items-center justify-center gap-6 mb-8 mt-8">
                            <button onclick="speakTarget()" class="w-14 h-14 rounded-full bg-yellow-500/20 border border-yellow-500 text-yellow-400 hover:bg-yellow-500/40 shadow-md transition-all flex items-center justify-center active:scale-95">
                                <i class="fas fa-volume-up text-xl"></i>
                            </button>
                            
                            <button onclick="toggleRecording()" id="record-btn" class="w-20 h-20 rounded-full bg-red-600 text-white shadow-xl transition-all hover:scale-105 active:scale-95 flex items-center justify-center relative z-10 border-4 border-black/30">
                                <i class="fas fa-microphone text-3xl" id="mic-icon"></i>
                            </button>
                        </div>

                        <div class="w-full border-t border-yellow-500/20 pt-6">
                            <p class="text-xs text-yellow-600 mb-2 font-bold uppercase">You said:</p>
                            <p id="spoken-text" class="text-lg md:text-xl text-yellow-200 italic min-h-[2rem]">Tap mic & speak...</p>
                            <div id="feedback-msg" class="mt-3 font-bold text-lg h-8 transition-all"></div>
                        </div>
                        
                        <div class="w-full mt-4 bg-black border border-gray-800 p-2 rounded text-left">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">Debug Log (Tell me what appears here):</p>
                            <div id="debug-console" class="text-xs text-green-400 font-mono h-16 overflow-y-auto">Waiting...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-freeplay" class="hidden flex-1 flex flex-col p-4 md:p-10 h-full pb-24 md:pb-10">
                <h2 class="text-xl md:text-2xl font-bold text-yellow-400 mb-4 md:mb-6">Text-to-Speech</h2>
                <div class="glass-panel p-6 rounded-3xl shadow-lg flex-1 flex flex-col">
                    <textarea id="free-text" class="w-full flex-1 bg-transparent border-none focus:ring-0 text-xl md:text-2xl text-yellow-300 resize-none placeholder-yellow-700/50" placeholder="Type anything here..."></textarea>
                    <div class="flex flex-col gap-4 mt-4 border-t border-yellow-500/20 pt-4">
                        <div class="w-full">
                            <div class="bg-black/40 rounded-xl border border-yellow-500/30 h-12 flex items-center px-4 justify-between">
                                <span class="text-xs font-bold text-yellow-600 mr-3 uppercase">Speed</span>
                                <input type="range" id="rate" min="0.5" max="2" value="1" step="0.1" oninput="updateRateLabel(this.value)" class="flex-1 h-2 bg-yellow-900 rounded-lg appearance-none cursor-pointer accent-yellow-400">
                                <span id="rate-value" class="text-xs font-bold text-yellow-400 ml-3 w-8 text-right">1.0x</span>
                            </div>
                        </div>
                        <button onclick="speakFreeText()" class="w-full py-4 bg-yellow-500 hover:bg-yellow-400 active:bg-yellow-600 text-black font-bold rounded-xl shadow-md active:scale-[0.98] transition-transform flex items-center justify-center text-lg">
                            <i class="fas fa-play mr-2"></i> Speak It
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="md:hidden fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur-xl border-t border-yellow-500/30 flex justify-around items-center pb-safe pt-2 z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.5)]">
            <button onclick="switchTab('challenge')" id="nav-mobile-challenge" class="nav-item active flex flex-col items-center justify-center p-3 w-1/2 text-yellow-600 transition-all rounded-xl mx-2">
                <i class="fas fa-trophy text-xl mb-1 transition-transform"></i>
                <span class="text-xs font-bold">Practice</span>
            </button>
            <button onclick="switchTab('freeplay')" id="nav-mobile-freeplay" class="nav-item flex flex-col items-center justify-center p-3 w-1/2 text-yellow-600 transition-all rounded-xl mx-2">
                <i class="fas fa-keyboard text-xl mb-1 transition-transform"></i>
                <span class="text-xs font-bold">Free Play</span>
            </button>
        </nav>
    </div>

    <script>
        const practiceData = {
            'Minimal Pairs': [
                { id: 1, text: "Ship vs Sheep", phrase: "The sheep is on the ship.", hint: "Short 'i' vs Long 'ee'" },
                { id: 2, text: "Bat vs Bet", phrase: "I bet on the bat.", hint: "Open 'a' vs Short 'e'" },
                { id: 3, text: "Fan vs Van", phrase: "The fan is in the van.", hint: "Soft 'f' vs Vibrating 'v'" },
                { id: 4, text: "Think vs Sink", phrase: "I think I will sink.", hint: "Tongue out 'th' vs Sibilant 's'" },
                { id: 5, text: "Bit vs Beet", phrase: "A little bit of beet.", hint: "Short I vs Long E" }
            ],
            'Tongue Twisters': [
                { id: 51, text: "Seashells", phrase: "She sells seashells by the seashore.", hint: "Watch your 'sh' and 's' sounds." }
            ],
            'Common Mistakes': [
                { id: 71, text: "Comfortable", phrase: "This chair is very comfortable.", hint: "Pronounced 'Comf-ter-bull'" }
            ]
        };

        let currentCategory = 'Minimal Pairs';
        let currentTarget = null;
        let isRecording = false;
        let recognition;
        let voices = [];

        // DOM
        const viewChallenge = document.getElementById('view-challenge');
        const viewFree = document.getElementById('view-freeplay');
        const btnChallenge = document.getElementById('btn-challenge-desktop');
        const btnFree = document.getElementById('btn-freeplay-desktop');
        const navMobileChallenge = document.getElementById('nav-mobile-challenge');
        const navMobileFree = document.getElementById('nav-mobile-freeplay');
        const categorySelect = document.getElementById('category-select');
        const cardsContainer = document.getElementById('cards-container');
        const practiceArea = document.getElementById('practice-area');
        const targetDisplay = document.getElementById('target-text');
        const spokenDisplay = document.getElementById('spoken-text');
        const feedbackMsg = document.getElementById('feedback-msg');
        const recordBtn = document.getElementById('record-btn');
        const practiceTag = document.getElementById('practice-tag');
        const statsCount = document.getElementById('stats-count');
        const mobileStatsCount = document.getElementById('mobile-stats-count');
        const debugConsole = document.getElementById('debug-console');

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            debugConsole.innerHTML += `[${time}] ${msg}<br>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(msg);
        }

        function getProgress() {
            const stored = localStorage.getItem('speakeasy_progress');
            return stored ? JSON.parse(stored) : [];
        }
        function saveProgress(id) {
            const progress = getProgress();
            if (!progress.includes(id)) {
                progress.push(id);
                localStorage.setItem('speakeasy_progress', JSON.stringify(progress));
                updateStats();
            }
        }
        function updateStats() {
            const progress = getProgress();
            const text = `${progress.length} / 120`;
            statsCount.innerText = text;
            mobileStatsCount.innerText = text;
        }

        window.onload = () => {
            log("App Started");
            initSpeechRecognition();
            loadVoices();
            initCategories();
            renderCards();
            updateStats();
            window.addEventListener('resize', () => {
                document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
            });
        };

        function switchTab(tab) {
            if (tab === 'challenge') {
                viewChallenge.classList.remove('hidden');
                viewFree.classList.add('hidden');
                btnChallenge.classList.replace('text-yellow-200/80', 'text-yellow-400');
                btnChallenge.classList.add('bg-yellow-500/20', 'shadow-sm', 'border-yellow-500/30');
                btnFree.classList.replace('text-yellow-400', 'text-yellow-200/80');
                btnFree.classList.remove('bg-yellow-500/20', 'shadow-sm', 'border-yellow-500/30');
                navMobileChallenge.classList.add('active');
                navMobileFree.classList.remove('active');
            } else {
                viewChallenge.classList.add('hidden');
                viewFree.classList.remove('hidden');
                btnFree.classList.replace('text-yellow-200/80', 'text-yellow-400');
                btnFree.classList.add('bg-yellow-500/20', 'shadow-sm', 'border-yellow-500/30');
                btnChallenge.classList.replace('text-yellow-400', 'text-yellow-200/80');
                btnChallenge.classList.remove('bg-yellow-500/20', 'shadow-sm', 'border-yellow-500/30');
                navMobileFree.classList.add('active');
                navMobileChallenge.classList.remove('active');
            }
        }

        function initCategories() {
            Object.keys(practiceData).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
            categorySelect.addEventListener('change', (e) => {
                currentCategory = e.target.value;
                renderCards();
                backToGrid();
            });
        }

        function renderCards() {
            cardsContainer.innerHTML = '';
            const completed = getProgress();
            practiceData[currentCategory].forEach(item => {
                const isDone = completed.includes(item.id);
                const card = document.createElement('div');
                const baseClass = "glass-panel p-5 rounded-2xl cursor-pointer hover:bg-yellow-500/10 border border-yellow-500/30 transition-all transform active:scale-[0.98] shadow-sm flex flex-col justify-between min-h-[100px]";
                card.className = isDone ? `${baseClass} card-completed` : baseClass;
                card.onclick = () => openPractice(item);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                         <span class="text-lg font-bold ${isDone ? 'text-green-400' : 'text-yellow-600'}">
                            ${isDone ? '<i class="fas fa-star"></i>' : `#${item.id}`}
                        </span>
                        <i class="fas fa-chevron-right text-yellow-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-yellow-400 leading-tight">${item.text}</h3>
                        <p class="text-yellow-200/70 text-sm line-clamp-1 mt-1">"${item.phrase}"</p>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
        }

        function openPractice(item) {
            cardsContainer.classList.add('hidden');
            practiceArea.classList.remove('hidden');
            categorySelect.parentElement.classList.add('hidden');
            currentTarget = item;
            targetDisplay.textContent = item.phrase;
            practiceTag.textContent = item.hint;
            spokenDisplay.textContent = "Tap mic & speak...";
            spokenDisplay.className = "text-lg md:text-xl text-yellow-600 italic";
            feedbackMsg.textContent = "";
            log(`Opened card: ${item.text}`);
        }

        function backToGrid() {
            cardsContainer.classList.remove('hidden');
            practiceArea.classList.add('hidden');
            categorySelect.parentElement.classList.remove('hidden');
            stopRecording();
            renderCards();
        }

        // --- SPEECH RECOGNITION ---
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                log("CRITICAL: Browser does not support SpeechRecognition.");
                document.getElementById('browser-warning').classList.remove('hidden');
                recordBtn.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false; // Set to false to simplify
            recognition.maxAlternatives = 1;
            recognition.continuous = false;

            recognition.onstart = () => {
                isRecording = true;
                updateMicUI(true);
                log("Mic Started. Speak now.");
                spokenDisplay.textContent = "Listening...";
                spokenDisplay.className = "text-xl text-yellow-300 font-semibold animate-pulse";
            };

            recognition.onend = () => {
                isRecording = false;
                updateMicUI(false);
                log("Mic Stopped.");
            };

            recognition.onerror = (event) => {
                isRecording = false;
                updateMicUI(false);
                log(`ERROR: ${event.error}`);
                
                let msg = `Error: ${event.error}`;
                if(event.error === 'not-allowed') msg = "BLOCKED: Allow Mic permission.";
                if(event.error === 'network') msg = "OFFLINE: Connect to internet.";
                feedbackMsg.textContent = msg;
                feedbackMsg.className = "mt-3 font-bold text-sm text-red-500";
            };

            recognition.onnomatch = (event) => {
                 log("No match found.");
                 feedbackMsg.textContent = "Didn't catch that.";
            };

            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                log(`Heard: "${result}" (Conf: ${event.results[0][0].confidence})`);
                spokenDisplay.textContent = `"${result}"`;
                spokenDisplay.className = "text-xl text-yellow-400 font-bold";
                checkMatch(result);
            };
            
            log("Speech API Initialized.");
        }

        function toggleRecording() {
            if (!recognition) return;
            if (isRecording) {
                recognition.stop();
            } else {
                log("Requesting Mic...");
                recognition.start();
            }
        }

        function stopRecording() {
            if (isRecording && recognition) recognition.stop();
        }

        function updateMicUI(recording) {
            const icon = document.getElementById('mic-icon');
            if (recording) {
                recordBtn.classList.replace('bg-red-600', 'bg-black');
                recordBtn.classList.replace('border-black/30', 'border-yellow-400');
                icon.className = "fas fa-stop text-3xl text-red-500";
            } else {
                recordBtn.classList.replace('bg-black', 'bg-red-600');
                recordBtn.classList.replace('border-yellow-400', 'border-black/30');
                icon.className = "fas fa-microphone text-3xl text-white";
            }
        }

        // --- MATCHING LOGIC ---
        function levenshteinDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) == a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        function checkMatch(spoken) {
            if(!currentTarget) return;
            const normalize = (str) => str.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s{2,}/g," ").trim();
            const cleanSpoken = normalize(spoken);
            const cleanTarget = normalize(currentTarget.phrase);
            
            const dist = levenshteinDistance(cleanSpoken, cleanTarget);
            const maxLength = Math.max(cleanSpoken.length, cleanTarget.length);
            const similarity = (maxLength - dist) / maxLength;

            log(`Match Score: ${Math.round(similarity * 100)}%`);

            if (similarity >= 0.8) {
                feedbackMsg.textContent = `Perfect! (Match: ${Math.round(similarity * 100)}%)`;
                feedbackMsg.className = "mt-3 font-bold text-lg text-green-500";
                saveProgress(currentTarget.id);
                triggerConfetti();
            } else {
                feedbackMsg.textContent = `Try again. (Match: ${Math.round(similarity * 100)}%)`;
                feedbackMsg.className = "mt-3 font-bold text-lg text-yellow-600";
            }
        }

        function loadVoices() {
            const populate = () => { voices = window.speechSynthesis.getVoices(); };
            populate();
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populate;
        }

        function updateRateLabel(val) {
            document.getElementById('rate-value').textContent = val + 'x';
        }

        function speak(text, rate = 1) {
            if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const voice = voices.find(v => v.lang.includes('en-US')) || voices.find(v => v.lang.includes('en'));
            if (voice) utterance.voice = voice;
            utterance.rate = rate;
            window.speechSynthesis.speak(utterance);
        }

        function speakTarget() { speak(currentTarget.phrase, 0.9); }

        function speakFreeText() {
            const text = document.getElementById('free-text').value;
            if(text.trim() !== "") speak(text, document.getElementById('rate').value);
        }

        function triggerConfetti() {
            const colors = ['#facc15', '#fbbf24', '#f59e0b', '#ffffff'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }
    </script>
</body>
</html>
